<html>
  <head>
    <meta charset="utf-8">
    <title>HKU graduation</title>

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jquery@3.5.0/dist/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js" integrity="sha512-UXumZrZNiOwnTcZSHLOfcTs0aos2MzBWHXOHOuB0J/R44QB0dwY5JgfbvljXcklVf65Gc4El6RjZ+lnwd2az2g==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.5.0/jszip.min.js" integrity="sha512-y3o0Z5TJF1UsKjs/jS2CDkeHN538bWsftxO9nctODL5W40nyXIbs0Pgyu7//icrQY9m6475gLaVr39i/uh/nLA==" crossorigin="anonymous"></script>
    
    <script src="../dist/mindar.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

    <script>
      let replayButton;
      const frames = [];

      const checkIOS = () => {
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        if (isIOS && !navigator.mediaDevices) { // good enough?
          return false;
        }
        return  true;
      };

      $(document).ready(function() {
        if (!checkIOS()) {
          $(".browser-support-overlay").show();
          $(".mindar-loading-overlay").hide();
          return;
        }

        //globalDetected();
        const sceneEl = document.querySelector('a-scene');
        const arSystem = sceneEl.systems['mindar-system'];
        startDownloadAssets(() => {
          arSystem.start();
          //globalDetected();
        })

        replayButton = document.querySelector("#replayButton");
        replayButton.addEventListener("click", () => {
          play();
        });
      });
      const globalDetected = (targetIndex) => {
        $(".mindar-scan-overlay").hide();
        play();
      };

      const startDownloadAssets = (done) => {
        const xhr = new XMLHttpRequest();
        xhr.responseType = "arraybuffer";
        xhr.onprogress = (e) => {
          if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            console.log("download progress...", percent);
          };
        };
        xhr.open('GET', './assets/hku-project/render/frames.zip', true);
        xhr.onload = (e) => {
          console.log("asset ready...", xhr.response);
          JSZip.loadAsync(xhr.response).then((zip) => {
            const zipEntries = [];
            zip.forEach((relativePath, zipEntry, index) => {
              if (relativePath.startsWith("_")) return;
              zipEntries.push(zipEntry);
            });

            let doneCount = 0;
            zipEntries.forEach((zipEntry, index) => {
              //console.log("entry: ", index, zipEntry);
              zipEntry.async("blob").then((blob) => {
                const url = URL.createObjectURL(blob);
                const img = new Image();
                img.src = url;

                const texture = new THREE.Texture();
                texture.image = img;
                texture.encoding = THREE.sRGBEncoding;
                texture.needsUpdate = true;

                frames[index] = texture;
                doneCount += 1;
                if (doneCount === zipEntries.length) {
                  done(frames);
                }
              });
            });
          });
        };
        xhr.send(null);
      };

      const play = () => {
        const hat = document.querySelector('#hatModel');
        const el = document.querySelector('#image-frame');
        const _play = () => {
          hat.setAttribute("visible", true);

          // ugly hack...
          if ( hat.components['animation-mixer']._tick) {
            hat.components['animation-mixer'].tick = hat.components['animation-mixer']._tick;
          }
          hat.components['animation-mixer'].stopAction();
          hat.components['animation-mixer'].playAction();

          el.setAttribute("visible", true);
          el.getObject3D('mesh').traverse((o) => {
            o.material.map = frames[0]; 
            let current = 0;
            const handler = setInterval(() => {
              current = (current + 1) % frames.length;
              if (current === 0) {
                clearInterval(handler);
                hat.components['animation-mixer']._tick = hat.components['animation-mixer'].tick;
                hat.components['animation-mixer'].tick = () => {};
                replayButton.style.visibility = "visible";
                return;
              }
              o.material.map = frames[current]; 
            }, 100);
          });
        }

        hat.setAttribute("visible", false);
        el.setAttribute("visible", false);
        replayButton.style.visibility = "hidden";

        const flashingPlane = document.querySelector("#flashing-plane");
        let flashingCount = 0;
        const flashingHandler = setInterval(() => {
          if (flashingCount % 2 === 0) {
            flashingPlane.style.visibility = "hidden";
          } else {
            flashingPlane.style.visibility = "visible";
          }
          flashingCount += 1;
          if (flashingCount === 30) {
            clearInterval(flashingHandler);
            flashingPlane.style.visibility = "hidden";
            _play();
          }
        }, 10);
      }
    </script>

    <style>
      body {
        margin: 0;
      }
      .example-container {
        overflow: hidden;
        position: absolute;
        width: 100%;
        height: 100%;
      }
      .example-container .mindar-loading-overlay {
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        background: white;
        opacity: 0.5;
        z-index: 2;
      }
      .example-container .mindar-loading-overlay .content {
        font-size: 30px;
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
      }

      .example-container .mindar-scan-overlay {
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        background: transparent;
        z-index: 2;
      }

      .example-container .mindar-scan-overlay .content {
        font-size: 30px;
        position: absolute;
        left: 20%;
        top: 20%;
        transform: translate(-10%, 20%);
      }
      .example-container .mindar-scan-overlay .content img {
        width: 100%;
      }

      .example-container .browser-support-overlay {
        display: none;
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        background: transparent;
        z-index: 2;
      }

      .example-container .browser-support-overlay .content {
        font-size: 30px;
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
      }
      .example-container .browser-support-overlay .content img {
        width: 100%;
      }

      #replayButton {
        visibility: hidden;
        background: transparent;
        border: none;
        position: absolute;
        right: 10;
        bottom: 10;
        z-index: 9999;
      }
      #replayButton img {
        width: 20vw;
      }

      .flashing-plane {
        visibility: hidden;
        background: #f5894a;
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        z-index: 10;
      }
    </style>
  </head>
  <body>
    <div class="example-container">
      <button id="replayButton"><img src="./assets/hku-project/reloading.png"/></button>
      <div class="mindar-loading-overlay">
        <div class="content">Loading...</div>
      </div>

      <div id="flashing-plane" class="flashing-plane">
      </div>

      <div class="browser-support-overlay">
        <div class="content">Safari browser is required for viewing this page.</div>
      </div>

      <div id="scanOverlay" class="mindar-scan-overlay" style="display: none">
        <div class="content">
          <img src="./assets/hku-project/scan.png"/>
        </div>
      </div>

      <a-scene mindar="imageTargetSrc: ./assets/hku-project/targets.mind; showStats: false; autoStart: false" embedded color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
         <a-assets>
          <a-asset-item id="hatModelAsset" src="./assets/hku-project/hat/scene.gltf"></a-asset-item>
          <img id="my-image" src="./assets/hku-project/render/hku0001.png">
        </a-assets>


        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        <!-- Default lighting injected by A-Frame. -->
        <a-entity light="type: ambient; color: #BBB"></a-entity>
        <a-entity light="type: spot; angle: 30; intensity: 0.7"></a-entity>
        <a-entity light="type: directional; color: #FFF; intensity: 0.6" position="-0.5 1 1"></a-entity>

        <a-image id="image-frame" visible="false" position="0 0 -3" rotation="0 0 0" width=7.20 height=12.80 material="alphaTest: 0.5" src="#my-image"></a-image>
        <a-gltf-model id="hatModel" visible="false" rotation="0 0 0 " position="0 0 -2" scale="1 1 1" src="#hatModelAsset" animation-mixer="clampWhenFinished: true;"></a-gltf-model>

      </a-scene>
    </div>
  </body>
</html>
